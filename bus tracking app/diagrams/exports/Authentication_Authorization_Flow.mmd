sequenceDiagram
    autonumber
    participant Client as ðŸ“± Mobile Client
    participant Gateway as ðŸ›¡ï¸ API Gateway / Middleware
    participant AuthCtrl as ðŸ” Auth Controller
    participant UserDB as ðŸ—„ï¸ MongoDB (Users)
    participant ProtectedRPC as ðŸ“¦ Protected Service
    participant SocketGW as ðŸ”Œ Socket.IO Gateway

    note over Client, SocketGW: ðŸ”’ PHASE 1: Authentication (Login)
    
    Client->>Gateway: POST /api/auth/login (email, password)
    Gateway->>AuthCtrl: Route Request
    AuthCtrl->>UserDB: Find User & Verify Password
    
    alt Invalid Credentials
        UserDB-->>AuthCtrl: Null / Mismatch
        AuthCtrl-->>Client: 401 Unauthorized
    else Valid Credentials
        UserDB-->>AuthCtrl: User Document
        AuthCtrl->>AuthCtrl: Generate JWT (Sign Payload)
        AuthCtrl-->>Client: 200 OK { token, userProfile }
    end

    note over Client, SocketGW: ðŸ” PHASE 2: Authorization (HTTP Request)
    
    Client->>Gateway: GET /api/buses (Header: Bearer JWT)
    Gateway->>Gateway: AuthMiddleware: Verify Signature & Expiry
    
    alt Invalid/Expired Token
        Gateway-->>Client: 401 Unauthorized
    else Valid Token
        Gateway->>Gateway: RBAC: Check Role Permissions
        
        alt Role Denied
            Gateway-->>Client: 403 Forbidden
        else Role Allowed
            Gateway->>ProtectedRPC: Forward Request
            ProtectedRPC-->>Client: 200 OK (Data)
        end
    end

    note over Client, SocketGW: âš¡ PHASE 3: Socket Authorization (Real-Time)
    
    Client->>SocketGW: WebSocket Handshake (auth: { token })
    SocketGW->>SocketGW: Verify Token & Extract User
    
    alt Token Valid
        SocketGW-->>Client: Connection Established
        Client->>SocketGW: emit('joinRoute', routeId)
        SocketGW->>SocketGW: Join Room
    else Token Invalid
        SocketGW-->>Client: Connection Error (Authentication Error)
        SocketGW->>SocketGW: Disconnect
    end
