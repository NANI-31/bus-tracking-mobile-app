sequenceDiagram
    participant Driver as ðŸšŒ Driver App
    participant Student as ðŸ“± Student App
    participant Admin as ðŸ’» Admin Portal
    participant SocketServer as âš¡ Socket.IO Server
    participant DB as ðŸ—„ï¸ MongoDB
    participant FCM as ðŸ”” Firebase Cloud Messaging

    Note over Driver, Admin: System Initialization & Handshake

    Driver->>SocketServer: Connect (Auth Token)
    SocketServer-->>Driver: Acknowledgement (SocketID assigned)
    Driver->>SocketServer: Join Room ("bus_101")
    
    Student->>SocketServer: Connect (Auth Token)
    SocketServer-->>Student: Acknowledgement
    Student->>SocketServer: Join Room ("route_5")

    Note over Driver, SocketServer: ðŸ“ Continuous Location Stream (Every 3s)

    loop Live Tracking
        Driver->>SocketServer: emit('updateLocation', {lat, lng, heading})
        SocketServer->>SocketServer: Validate Data
        
        par Broadcast to Route Subscribers
            SocketServer-->>Student: emit('busLocation', {lat, lng})
        and Persist Async
            SocketServer->>DB: Update Bus Current Location
        end
    end

    Note over Driver, Admin: ðŸš¨ incident Reporting Event

    Driver->>SocketServer: emit('reportIncident', {type: 'Breakdown'})
    SocketServer->>DB: Create Incident Record
    
    par Notify Admins
        SocketServer-->>Admin: emit('incidentAlert', {busId: '101'})
    and Push Notification
        SocketServer->>FCM: Send High Priority Notification
        FCM-->>Student: Push Notification ("Bus Breakdown")
    end
